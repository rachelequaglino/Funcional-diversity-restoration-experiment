---
title: "Species performances across treatments"
author: "Rachele Quaglino"
date: "1/8/2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Load Data}
library(readxl)
TreeDataGrowth <- read_excel("~/Desktop/Master/3. master thesis/Data/2026/FDiv_PlantedTreeData_final_excel.xlsx", 
    col_types = c("text", "numeric", "text", 
        "numeric", "text", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))
```

```{r Load packages}
library(dplyr)
library(ggplot2)
library(lme4)
library(lmerTest)
library(performance)
library(emmeans)
library(car)
library(emmeans)
library(multcomp)
library(tidyr)
library(RColorBrewer)
library(patchwork)
```

```{r Total BA per plot year 3}
# Summing BA within each plot
plot_level_BA <- TreeDataGrowth %>%
  group_by(Site, Treatment, Plot_number) %>%
  summarise(
    Total_BA = sum(BA_year_3, na.rm = TRUE),
    .groups = "drop"
  )

# Calculating average plot-level BA per treatment
avg_plot_BA <- plot_level_BA %>%
  group_by(Site, Treatment) %>%
  summarise(
    mean_BA = mean(Total_BA, na.rm = TRUE), # Average total BA per treatment
    sd_BA = sd(Total_BA, na.rm = TRUE),   # Standard deviation for error bars
    n         = sum(!is.na(Total_BA)),
    se_BA   = sd_BA / sqrt(n),
    ci_BA   = qt(0.975, df = n - 1) * se_BA,
    .groups = "drop"
  )

avg_plot_BA <- avg_plot_BA %>%
  mutate(Treatment = factor(Treatment, levels = c("M1", "M2", "2SP", "6SP", "12SP")))

###Significance letters

#fit model
model_plot_ba <- lmer(
  Total_BA ~ Treatment * Site +  (1 | Site/Plot_number),
  data = plot_level_BA
) 
summary(model_plot_ba)

#Anova type III to check significance of fixed effects in the model
Anova(model_plot_ba)

#extract model means
means_plot_ba <- emmeans (model_plot_ba, pairwise ~ Treatment | Site , type = "response", data = plot_level_BA)

#calculate significant differences
cld_sign_plot_ba <- as.data.frame(cld(means_plot_ba, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE))

#change the order of factors
cld_sign_plot_ba$Treatment <- factor(cld_sign_plot_ba$Treatment, levels = c("M1", "M2", "2SP", "6SP", "12SP"))


#plot 
totalba3<- ggplot(avg_plot_BA, aes(x = Treatment, y = mean_BA, fill = Treatment)) +
  geom_bar(stat = "identity", color = "black") +
  geom_errorbar(aes(ymin = pmax(mean_BA - ci_BA, 0),
                  ymax = mean_BA + ci_BA),
              width = 0.2,
              size = 0.5)+
  geom_jitter(data = plot_level_BA, aes(x = Treatment, y = Total_BA), 
              color = "black", alpha = 0.5, width = 0.1) + # Add individual plot points
  geom_text(data = cld_sign_plot_ba, family= "sans", show.legend = FALSE, check_overlap = FALSE, 
            size = 3, vjust = 1, aes(x=Treatment,y=Inf,label=.group))+
  theme_classic() +
  facet_wrap(~Site)+
  scale_fill_manual(values = c( "12SP" = "darkolivegreen",
                               "2SP" = "darkseagreen2", 
                               "6SP" = "darkseagreen", 
                               "M1" = "firebrick", 
                               "M2"= "coral"), guide = "none") +
  labs(
    x = "Treatment",
    y = "Average Plot-level Basal Area"
  ) 

print(totalba3)
#save plot
ggsave("~/Desktop/totalba3.jpeg", plot=totalba3, width = 8, height = 5, dpi = 300)
ggsave("~/Desktop/totalba3.svg", plot=totalba3)

```
```{r Total BA per plot year 3 - pooled}
### 1️⃣ Summing BA within each plot
plot_level_BA <- TreeDataGrowth %>%
  group_by(Site, Treatment, Plot_number) %>%
  summarise(
    Total_BA = sum(BA_year_3, na.rm = TRUE),
    .groups = "drop"
  )

# Set treatment order
plot_level_BA$Treatment <- factor(
  plot_level_BA$Treatment,
  levels = c("M1", "M2", "2SP", "6SP", "12SP")
)

### 2️⃣ Fit pooled mixed model (NO interaction)
model_plot_ba_pool <- lmer(
  Total_BA ~ Treatment + (1 | Site),
  data = plot_level_BA
)

summary(model_plot_ba_pool)

# Type III ANOVA
Anova(model_plot_ba_pool)

### 3️⃣ Extract estimated marginal means
means_plot_ba_pool <- emmeans(
  model_plot_ba_pool,
  pairwise ~ Treatment,
  type = "response"
)

### 4️⃣ Calculate significance letters
cld_sign_plot_ba_pool <- as.data.frame(
  cld(means_plot_ba_pool,
      Letters = letters,
      adjust = "BH",
      alpha = 0.05, decreasing = TRUE)
)

# Ensure correct order
cld_sign_plot_ba_pool$Treatment <- factor(
  cld_sign_plot_ba_pool$Treatment,
  levels = c("M1", "M2", "2SP", "6SP", "12SP")
)

### 5️⃣ Calculate pooled descriptive means (for plotting bars)
avg_plot_BA_pool <- plot_level_BA %>%
  group_by(Treatment) %>%
  summarise(mean_BA = mean(Total_BA, na.rm = TRUE), # Average total BA per treatment
    sd_BA = sd(Total_BA, na.rm = TRUE),   # Standard deviation for error bars
    n         = sum(!is.na(Total_BA)),
    se_BA   = sd_BA / sqrt(n),
    ci_BA   = qt(0.975, df = n - 1) * se_BA,
    .groups = "drop"
  )

avg_plot_BA_pool$Treatment <- factor(
  avg_plot_BA_pool$Treatment,
  levels = c("M1", "M2", "2SP", "6SP", "12SP")
)

### 6️⃣ Create pooled plot
totalba_pool <- ggplot(avg_plot_BA_pool,
                       aes(x = Treatment,
                           y = mean_BA,
                           fill = Treatment)) +
  geom_bar(stat = "identity", color = "black") +
  geom_errorbar(aes(ymin = pmax(mean_BA - ci_BA, 0),
                  ymax = mean_BA + ci_BA),
              width = 0.2,
              size = 0.5)+
  geom_jitter(
    data = plot_level_BA,
    aes(x = Treatment, y = Total_BA),
    color = "black",
    alpha = 0.5,
    width = 0.1
  ) +
  geom_text(
    data = cld_sign_plot_ba_pool,
    aes(x = Treatment,
        y = Inf,
        label = .group), cjust = 1,
    size = 4
  ) +
  theme_classic() +
  scale_fill_manual(
    values = c(
      "12SP" = "darkolivegreen",
      "2SP"  = "darkseagreen2",
      "6SP"  = "darkseagreen",
      "M1"   = "firebrick",
      "M2"   = "coral"
    ),
    guide = "none"
  ) +
  labs(
    x = "Treatment",
    y = "Average Plot-level Basal Area"
  )

print(totalba_pool)

### 7️⃣ Save plot
ggsave("~/Desktop/totalba3_pool.jpeg",
       plot = totalba_pool,
       width = 8,
       height = 5.5,
       dpi = 300)

ggsave("~/Desktop/totalba3_pool.svg",
       plot = totalba_pool)

```

```{r Average Height per plot year 3}
plot_level_height <- TreeDataGrowth %>%
  group_by(Site, Treatment, Plot_number) %>%
  summarise(
    avg_height_3 = mean(Height_year_3, na.rm = TRUE),
    sd_height_3 = sd(Height_year_3, na.rm = TRUE),
    .groups = "drop"
  )

# Set treatment order
plot_level_height$Treatment <- factor(
  plot_level_height$Treatment,
  levels = c("M1", "M2", "2SP", "6SP", "12SP")
)

avg_plot_height <- plot_level_height %>% 
  group_by(Site, Treatment) %>% 
  summarise(mean_height = mean(avg_height_3, na.rm = TRUE), # Average total BA per treatment
    sd_height = sd(avg_height_3, na.rm = TRUE),   # Standard deviation for error bars
    n         = sum(!is.na(avg_height_3)),
    se_height   = sd_height / sqrt(n),
    ci_height   = qt(0.975, df = n - 1) * se_height,
    .groups = "drop"
  )


#model
model_plot_height <- lmer(
  avg_height_3 ~ Treatment * Site +  (1 | Site/Plot_number),
  data = plot_level_height
)

#extract model means
means_plot_height <- emmeans (model_plot_height, pairwise ~ Treatment | Site , type = "response", data = plot_level_height)

#calculate significant differences
cld_sign_plot_height <- as.data.frame(cld(means_plot_height, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE))

#change the order of factors
cld_sign_plot_height$Treatment <- factor(cld_sign_plot_height$Treatment, levels = c("M1", "M2", "2SP", "6SP", "12SP"))


#plot 
avgheight3<- ggplot(avg_plot_height, aes(x = Treatment, y = mean_height, fill = Treatment)) +
  geom_bar(stat = "identity", color = "black") +
  geom_errorbar(aes(ymin = pmax(mean_height - ci_height, 0),
                  ymax = mean_height + ci_height),
              width = 0.2,
              size = 0.5)+
  geom_jitter(data = plot_level_height, aes(x = Treatment, y = avg_height_3), 
              color = "black", alpha = 0.5, width = 0.1) + # Add individual plot points
  geom_text(data = cld_sign_plot_height, family= "sans", show.legend = FALSE, check_overlap = FALSE, 
            size = 3, vjust = 1, aes(x=Treatment,y=Inf,label=.group))+
  theme_classic() +
  facet_wrap(~Site)+
  scale_fill_manual(values = c( "12SP" = "darkolivegreen",
                               "2SP" = "darkseagreen2", 
                               "6SP" = "darkseagreen", 
                               "M1" = "firebrick", 
                               "M2"= "coral"), guide = "none") +
  labs(
    x = "Treatment",
    y = "Average Plot-level Height"
  ) 

print(avgheight3)
#save plot
ggsave("~/Desktop/avgheight3.jpeg", plot=avgheight3, width = 8, height = 5, dpi = 300)
ggsave("~/Desktop/avgheight3.svg", plot=avgheight3)
```

```{r Average Height per plot year 3 - pooled}
plot_level_height <- TreeDataGrowth %>%
  group_by(Site, Treatment, Plot_number) %>%
  summarise(
    avg_height_3 = mean(Height_year_3, na.rm = TRUE),
    sd_height_3 = sd(Height_year_3, na.rm = TRUE),
    .groups = "drop"
  )

# Set treatment order
plot_level_height$Treatment <- factor(
  plot_level_height$Treatment,
  levels = c("M1", "M2", "2SP", "6SP", "12SP")
)

### 2️⃣ Fit pooled mixed model (NO interaction)
model_plot_height_pool <- lmer(
  avg_height_3 ~ Treatment + (1 | Site),
  data = plot_level_height
)

summary(model_plot_height_pool)

# Type III ANOVA
Anova(model_plot_height_pool)

### 3️⃣ Extract estimated marginal means
means_plot_height_pool <- emmeans(
  model_plot_height_pool,
  pairwise ~ Treatment,
  type = "response"
)

### 4️⃣ Calculate significance letters
cld_sign_plot_height_pool <- as.data.frame(
  cld(means_plot_height_pool,
      Letters = letters,
      adjust = "BH",
      alpha = 0.05, 
      decreasing = TRUE)
)

# Ensure correct order
cld_sign_plot_height_pool$Treatment <- factor(
  cld_sign_plot_height_pool$Treatment,
  levels = c("M1", "M2", "2SP", "6SP", "12SP")
)

### 5️⃣ Calculate pooled descriptive means (for plotting bars)
avg_plot_height_pool <- plot_level_height %>%
  group_by(Treatment) %>%
  summarise(mean_height = mean(avg_height_3, na.rm = TRUE), # Average total BA per treatment
    sd_height = sd(avg_height_3, na.rm = TRUE),   # Standard deviation for error bars
    n         = sum(!is.na(avg_height_3)),
    se_height   = sd_height / sqrt(n),
    ci_height   = qt(0.975, df = n - 1) * se_height,
    .groups = "drop"
  )

avg_plot_height_pool$Treatment <- factor(
  avg_plot_height_pool$Treatment,
  levels = c("M1", "M2", "2SP", "6SP", "12SP")
)

### 6️⃣ Create pooled plot
avgheight_pool <- ggplot(avg_plot_height_pool,
                       aes(x = Treatment,
                           y = mean_height,
                           fill = Treatment)) +
  geom_bar(stat = "identity", color = "black") +
  geom_errorbar(aes(ymin = pmax(mean_height - ci_height, 0),
                  ymax = mean_height + ci_height),
              width = 0.2,
              size = 0.5)+
  geom_jitter(
    data = plot_level_height,
    aes(x = Treatment, y = avg_height_3),
    color = "black",
    alpha = 0.5,
    width = 0.1
  ) +
  geom_text(
    data = cld_sign_plot_height_pool,
    aes(x = Treatment,
        y = Inf,
        label = .group), cjust = 1,
    size = 4
  ) +
  theme_classic() +
  scale_fill_manual(
    values = c(
      "12SP" = "darkolivegreen",
      "2SP"  = "darkseagreen2",
      "6SP"  = "darkseagreen",
      "M1"   = "firebrick",
      "M2"   = "coral"
    ),
    guide = "none"
  ) +
  labs(
    x = "Treatment",
    y = "Average Plot-level Height"
  )

print(avgheight_pool)

### 7️⃣ Save plot
ggsave("~/Desktop/avgheight_pool.jpeg",
       plot = avgheight_pool,
       width = 8,
       height = 5.5,
       dpi = 300)

ggsave("~/Desktop/avgheight_pool.svg",
       plot = avgheight_pool)

```

```{r Calculate RGR height}
# Add the RGR for Height to TreeDataGrowth 
TreeDataGrowthHeight <- TreeDataGrowth %>%
  filter(
    (Site == "LLFS" & Height_year_2 > 0 & Height_year_3 > 0) |
    (Site != "LLFS" & Height_year_1 > 0 & Height_year_3 > 0)
  ) %>%
  mutate(
    initial_height = case_when(
      Site == "LLFS" ~ Height_year_2,
      TRUE           ~ Height_year_1
    ),
    days = case_when(
      Site == "LLFS" ~ 366,
      Site == "FCEA" ~ 731,
      Site == "FAB" ~ 700,
      Site == "GAM" ~ 709
    ),
    RGR_Height = (log(Height_year_3) - log(initial_height)) / days
  )

#There are negative RGRs so filter them out
TreeDataGrowthHeight <- TreeDataGrowthHeight %>% 
  filter(RGR_Height > 0)
```

```{r Plot all in one complete figure + modeling}
TreeDataGrowthHeight <- TreeDataGrowthHeight %>%
  mutate(
    Species_group = if_else(
      Species == "Inga edulis",
      "Inga edulis",
      "All Other Species"
    )
  ) %>% 
  mutate(Treatment = factor(Treatment, levels = c("M1", "M2", "2SP", "6SP", "12SP")))

model_BA <- lmer(
  BA_year_3 ~ Treatment * Species_group + (1 | Site/Plot_number),
  data = TreeDataGrowthHeight
)

Anova(model_BA, type = 3)

model_height <- lmer(
  Height_year_3 ~ Treatment * Species_group + (1 | Site/Plot_number),
  data = TreeDataGrowthHeight
)

Anova(model_height, type = 3)

model_RGR <- lmer(
  RGR_Height ~ Treatment * Species_group + (1 | Site/Plot_number),
  data = TreeDataGrowthHeight
)

Anova(model_RGR, type = 3)

## SIGNIFICANCE LETTERS

emm_BA <- emmeans(model_BA, ~ Treatment | Species_group)

cld_BA <- as.data.frame(
  cld(emm_BA, Letters = letters, adjust = "Tukey", decreasing = TRUE)
)

emm_height <- emmeans(model_height, ~ Treatment | Species_group)

cld_height <- as.data.frame(
  cld(emm_height, Letters = letters, adjust = "Tukey", decreasing = TRUE)
)

emm_RGR <- emmeans(model_RGR, ~ Treatment | Species_group)

cld_RGR <- as.data.frame(
  cld(emm_RGR, Letters = letters, adjust = "Tukey", decreasing = TRUE)
)

##DESCRIPTIVE SUMMARY FOR PLOTTING
CombinedSummary_pooled <- TreeDataGrowthHeight %>%
  group_by(Treatment, Species_group) %>%
  summarise(
    Mean_BA_3 = mean(BA_year_3, na.rm = TRUE),
    sd_BA_3 = sd(BA_year_3, na.rm = TRUE),
    Mean_Height_3 = mean(Height_year_3, na.rm = TRUE),
    sd_Height_3 = sd(Height_year_3, na.rm = TRUE),
    mean_RGR = mean(RGR_Height, na.rm = TRUE),
    sd_RGR = sd(RGR_Height, na.rm = TRUE),
    .groups = "drop"
  )

## PLOT
species_colors <- c(brewer.pal(n = 8, name = "Dark2"), "black")

p_BA <- ggplot(CombinedSummary_pooled,
               aes(x = Treatment,
                   y = Mean_BA_3,
                   color = Species_group,
                   group = Species_group)) +
  geom_point(size = 6, alpha = 0.7) +
  geom_errorbar(aes(ymin = Mean_BA_3 - sd_BA_3,
                    ymax = Mean_BA_3 + sd_BA_3),
                width = 0.15,
                size = 0.4) +
  geom_line(size = 1.2, alpha = 0.8) +
  geom_text(data = cld_BA,
            aes(x = Treatment,
                y = emmean * 1.05,
                label = .group,
                color = Species_group),
            position = position_dodge(width = 0.4),
            size = 3,
            show.legend = FALSE) +
  scale_color_manual(values = species_colors) +
  theme_classic() +
  theme(legend.position = "none",
        axis.title = element_text(size = 14)) +
  labs(x = "Treatment",
       y = expression("Mean Individual BA (" * cm^2 * ")"),
       tag = "a)")
p_BA
p_height <- ggplot(CombinedSummary_pooled,
                   aes(x = Treatment,
                       y = Mean_Height_3,
                       color = Species_group,
                       group = Species_group)) +
  geom_point(size = 6, alpha = 0.7) +
  geom_errorbar(aes(ymin = Mean_Height_3 - sd_Height_3,
                    ymax = Mean_Height_3 + sd_Height_3),
                width = 0.15,
                size = 0.4) +
  geom_line(size = 1.2, alpha = 0.8) +
  geom_text(data = cld_height,
            aes(x = Treatment,
                y = emmean * 1.05,
                label = .group,
                color = Species_group),
            position = position_dodge(width = 0.4),
            size = 3,
            show.legend = FALSE) +
  scale_color_manual(values = species_colors) +
  theme_classic() +
  theme(legend.position = "none",
        axis.title = element_text(size = 14)) +
  labs(x = "Treatment",
       y = "Mean Individual Height (cm)",
       tag = "b)")

p_RGR <- ggplot(CombinedSummary_pooled,
                aes(x = Treatment,
                    y = mean_RGR,
                    color = Species_group,
                    group = Species_group)) +
  geom_point(size = 6, alpha = 0.7) +
  geom_errorbar(aes(ymin = mean_RGR - sd_RGR,
                    ymax = mean_RGR + sd_RGR),
                width = 0.15,
                size = 0.4) +
  geom_line(size = 1.2, alpha = 0.8) +
  geom_text(data = cld_RGR,
            aes(x = Treatment,
                y = emmean * 1.05,
                label = .group,
                color = Species_group),
            position = position_dodge(width = 0.4),
            size = 3,
            show.legend = FALSE) +
  scale_color_manual(values = species_colors) +
  theme_classic() +
  theme(axis.title = element_text(size = 14)) +
  labs(x = "Treatment",
       y = expression("Mean RGR (Height, cm/day)"),
       tag = "c)")
## COMBINE INTO FINAL FIGURE

final_monoculture_plot <- 
  (p_BA | p_height) / p_RGR +
  plot_layout(heights = c(1, 1.2)) &
  theme(
    plot.tag = element_text(size = 16, face = "bold"),
    plot.tag.position = c(0.02, 0.98)
  )

final_monoculture_plot

ggsave("~/Desktop/Monoculture_combined.jpeg",
       final_monoculture_plot,
       width = 10,
       height = 8,
       dpi = 600)

ggsave("~/Desktop/Monoculture_combined.svg",
       final_monoculture_plot,
       width = 10,
       height = 8)

```
