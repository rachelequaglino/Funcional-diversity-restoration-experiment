---
title: "Species performances across treatments"
author: "Rachele Quaglino"
date: "1/8/2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Load Data}
library(readxl)
TreeDataGrowth <- read_excel("~/Desktop/Master/3. master thesis/Data/2026/FDiv_PlantedTreeData_final_excel.xlsx", 
    col_types = c("text", "numeric", "text", 
        "numeric", "text", "numeric", "numeric", 
        "numeric", "numeric", "numeric", 
        "numeric", "numeric"))
```

```{r Load packages}
library(dplyr)
library(ggplot2)
library(lme4)
library(lmerTest)
library(performance)
library(emmeans)
library(car)
library(emmeans)
library(multcomp)
library(tidyr)
library(RColorBrewer)
```

```{r Total BA per plot year 3}
# Summing BA within each plot
plot_level_BA <- TreeDataGrowth %>%
  group_by(Site, Treatment, Plot_number) %>%
  summarise(
    Total_BA = sum(BA_year_3, na.rm = TRUE),
    .groups = "drop"
  )

# Calculating average plot-level BA per treatment
avg_plot_BA <- plot_level_BA %>%
  group_by(Site, Treatment) %>%
  summarise(
    Avg_BA = mean(Total_BA, na.rm = TRUE), # Average total BA per treatment
    SD_BA = sd(Total_BA, na.rm = TRUE),   # Standard deviation for error bars
    .groups = "drop"
  )

avg_plot_BA <- avg_plot_BA %>%
  mutate(Treatment = factor(Treatment, levels = c("M1", "M2", "2SP", "6SP", "12SP")))

###Significance letters

#fit model
model_plot_ba <- lmer(
  Total_BA ~ Treatment * Site +  (1 | Site/Plot_number),
  data = plot_level_BA
) 
summary(model_plot_ba)

#Anova type III to check significance of fixed effects in the model
Anova(model_plot_ba)

#extract model means
means_plot_ba <- emmeans (model_plot_ba, pairwise ~ Treatment | Site , type = "response", data = plot_level_BA)

#calculate significant differences
library(multcomp)
cld_sign_plot_ba <- as.data.frame(cld(means_plot_ba, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE))

#change the order of factors
cld_sign_plot_ba$Treatment <- factor(cld_sign_plot_ba$Treatment, levels = c("M1", "M2", "2SP", "6SP", "12SP"))


#plot 
totalba3<- ggplot(avg_plot_BA, aes(x = Treatment, y = Avg_BA, fill = Treatment)) +
  geom_bar(stat = "identity", color = "black") +
  geom_errorbar(aes(ymin = Avg_BA - SD_BA, ymax = Avg_BA + SD_BA), 
                width = 0.2, color = "black") +
  geom_jitter(data = plot_level_BA, aes(x = Treatment, y = Total_BA), 
              color = "black", alpha = 0.5, width = 0.1) + # Add individual plot points
  geom_text(data = cld_sign_plot_ba, family= "sans", show.legend = FALSE, check_overlap = FALSE, 
            size = 3, vjust = 1, aes(x=Treatment,y=Inf,label=.group))+
  theme_classic() +
  facet_wrap(~Site)+
  scale_fill_manual(values = c( "12SP" = "darkolivegreen",
                               "2SP" = "darkseagreen2", 
                               "6SP" = "darkseagreen", 
                               "M1" = "firebrick", 
                               "M2"= "coral"), guide = "none") +
  labs(
    x = "Treatment",
    y = "Average Plot-level Basal Area"
  ) 

print(totalba3)
#save plot
ggsave("~/Desktop/totalba3.jpeg", plot=totalba3, width = 8, height = 5, dpi = 300)
ggsave("~/Desktop/totalba3.svg", plot=totalba3)

```
```{r Total BA per plot year 3 - pooled}
### 1️⃣ Summing BA within each plot
plot_level_BA <- TreeDataGrowth %>%
  group_by(Site, Treatment, Plot_number) %>%
  summarise(
    Total_BA = sum(BA_year_3, na.rm = TRUE),
    .groups = "drop"
  )

# Set treatment order
plot_level_BA$Treatment <- factor(
  plot_level_BA$Treatment,
  levels = c("M1", "M2", "2SP", "6SP", "12SP")
)

### 2️⃣ Fit pooled mixed model (NO interaction)
model_plot_ba_pool <- lmer(
  Total_BA ~ Treatment + (1 | Site),
  data = plot_level_BA
)

summary(model_plot_ba_pool)

# Type III ANOVA
Anova(model_plot_ba_pool)

### 3️⃣ Extract estimated marginal means
means_plot_ba_pool <- emmeans(
  model_plot_ba_pool,
  pairwise ~ Treatment,
  type = "response"
)

### 4️⃣ Calculate significance letters
cld_sign_plot_ba_pool <- as.data.frame(
  cld(means_plot_ba_pool,
      Letters = letters,
      adjust = "BH",
      alpha = 0.05, decreasing = TRUE)
)

# Ensure correct order
cld_sign_plot_ba_pool$Treatment <- factor(
  cld_sign_plot_ba_pool$Treatment,
  levels = c("M1", "M2", "2SP", "6SP", "12SP")
)

### 5️⃣ Calculate pooled descriptive means (for plotting bars)
avg_plot_BA_pool <- plot_level_BA %>%
  group_by(Treatment) %>%
  summarise(
    Avg_BA = mean(Total_BA, na.rm = TRUE),
    SD_BA  = sd(Total_BA, na.rm = TRUE),
    .groups = "drop"
  )

avg_plot_BA_pool$Treatment <- factor(
  avg_plot_BA_pool$Treatment,
  levels = c("M1", "M2", "2SP", "6SP", "12SP")
)

### 6️⃣ Create pooled plot
totalba_pool <- ggplot(avg_plot_BA_pool,
                       aes(x = Treatment,
                           y = Avg_BA,
                           fill = Treatment)) +
  geom_bar(stat = "identity", color = "black") +
  geom_errorbar(
    aes(ymin = Avg_BA - SD_BA,
        ymax = Avg_BA + SD_BA),
    width = 0.2,
    color = "black"
  ) +
  geom_jitter(
    data = plot_level_BA,
    aes(x = Treatment, y = Total_BA),
    color = "black",
    alpha = 0.5,
    width = 0.1
  ) +
  geom_text(
    data = cld_sign_plot_ba_pool,
    aes(x = Treatment,
        y = Inf,
        label = .group), cjust = 1,
    size = 4
  ) +
  theme_classic() +
  scale_fill_manual(
    values = c(
      "12SP" = "darkolivegreen",
      "2SP"  = "darkseagreen2",
      "6SP"  = "darkseagreen",
      "M1"   = "firebrick",
      "M2"   = "coral"
    ),
    guide = "none"
  ) +
  labs(
    x = "Treatment",
    y = "Average Plot-level Basal Area"
  )

print(totalba_pool)

### 7️⃣ Save plot
ggsave("~/Desktop/totalba3_pool.jpeg",
       plot = totalba_pool,
       width = 8,
       height = 5.5,
       dpi = 300)

ggsave("~/Desktop/totalba3_pool.svg",
       plot = totalba_pool)

```

```{r Average Height per plot year 3}
plot_level_height <- TreeDataGrowth %>%
  group_by(Site, Treatment, Plot_number) %>%
  summarise(
    avg_height_3 = mean(Height_year_3, na.rm = TRUE),
    sd_height_3 = sd(Height_year_3, na.rm = TRUE),
    .groups = "drop"
  )

# Set treatment order
plot_level_height$Treatment <- factor(
  plot_level_height$Treatment,
  levels = c("M1", "M2", "2SP", "6SP", "12SP")
)

avg_plot_height <- plot_level_height %>% 
  group_by(Site, Treatment) %>% 
  summarise(
    Avg_height = mean(avg_height_3, na.rm = TRUE),
    SD_height = sd(avg_height_3, na.rm = TRUE),
    .groups = "drop"
  )


#model
model_plot_height <- lmer(
  avg_height_3 ~ Treatment * Site +  (1 | Site/Plot_number),
  data = plot_level_height
)

#extract model means
means_plot_height <- emmeans (model_plot_height, pairwise ~ Treatment | Site , type = "response", data = plot_level_height)

#calculate significant differences
cld_sign_plot_height <- as.data.frame(cld(means_plot_height, Letters = letters, adjust = "BH", alpha = 0.05, decreasing = TRUE))

#change the order of factors
cld_sign_plot_height$Treatment <- factor(cld_sign_plot_height$Treatment, levels = c("M1", "M2", "2SP", "6SP", "12SP"))


#plot 
avgheight3<- ggplot(avg_plot_height, aes(x = Treatment, y = Avg_height, fill = Treatment)) +
  geom_bar(stat = "identity", color = "black") +
  geom_errorbar(aes(ymin = Avg_height - SD_height, ymax = Avg_height + SD_height), 
                width = 0.2, color = "black") +
  geom_jitter(data = plot_level_height, aes(x = Treatment, y = avg_height_3), 
              color = "black", alpha = 0.5, width = 0.1) + # Add individual plot points
  geom_text(data = cld_sign_plot_height, family= "sans", show.legend = FALSE, check_overlap = FALSE, 
            size = 3, vjust = 1, aes(x=Treatment,y=Inf,label=.group))+
  theme_classic() +
  facet_wrap(~Site)+
  scale_fill_manual(values = c( "12SP" = "darkolivegreen",
                               "2SP" = "darkseagreen2", 
                               "6SP" = "darkseagreen", 
                               "M1" = "firebrick", 
                               "M2"= "coral"), guide = "none") +
  labs(
    x = "Treatment",
    y = "Average Plot-level Height"
  ) 

print(avgheight3)
#save plot
ggsave("~/Desktop/avgheight3.jpeg", plot=avgheight3, width = 8, height = 5, dpi = 300)
ggsave("~/Desktop/avgheight3.svg", plot=avgheight3)
```

```{r Average Height per plot year 3 - pooled}
plot_level_height <- TreeDataGrowth %>%
  group_by(Site, Treatment, Plot_number) %>%
  summarise(
    avg_height_3 = mean(Height_year_3, na.rm = TRUE),
    sd_height_3 = sd(Height_year_3, na.rm = TRUE),
    .groups = "drop"
  )

# Set treatment order
plot_level_height$Treatment <- factor(
  plot_level_height$Treatment,
  levels = c("M1", "M2", "2SP", "6SP", "12SP")
)

### 2️⃣ Fit pooled mixed model (NO interaction)
model_plot_height_pool <- lmer(
  avg_height_3 ~ Treatment + (1 | Site),
  data = plot_level_height
)

summary(model_plot_height_pool)

# Type III ANOVA
Anova(model_plot_height_pool)

### 3️⃣ Extract estimated marginal means
means_plot_height_pool <- emmeans(
  model_plot_height_pool,
  pairwise ~ Treatment,
  type = "response"
)

### 4️⃣ Calculate significance letters
cld_sign_plot_height_pool <- as.data.frame(
  cld(means_plot_height_pool,
      Letters = letters,
      adjust = "BH",
      alpha = 0.05, 
      decreasing = TRUE)
)

# Ensure correct order
cld_sign_plot_height_pool$Treatment <- factor(
  cld_sign_plot_height_pool$Treatment,
  levels = c("M1", "M2", "2SP", "6SP", "12SP")
)

### 5️⃣ Calculate pooled descriptive means (for plotting bars)
avg_plot_height_pool <- plot_level_height %>%
  group_by(Treatment) %>%
  summarise(
    Avg_height = mean(avg_height_3, na.rm = TRUE),
    SD_height  = mean(sd_height_3, na.rm = TRUE),
    .groups = "drop"
  )

avg_plot_height_pool$Treatment <- factor(
  avg_plot_height_pool$Treatment,
  levels = c("M1", "M2", "2SP", "6SP", "12SP")
)

### 6️⃣ Create pooled plot
avgheight_pool <- ggplot(avg_plot_height_pool,
                       aes(x = Treatment,
                           y = Avg_height,
                           fill = Treatment)) +
  geom_bar(stat = "identity", color = "black") +
  geom_errorbar(
    aes(ymin = Avg_height - SD_height,
        ymax = Avg_height + SD_height),
    width = 0.2,
    color = "black"
  ) +
  geom_jitter(
    data = plot_level_height,
    aes(x = Treatment, y = avg_height_3),
    color = "black",
    alpha = 0.5,
    width = 0.1
  ) +
  geom_text(
    data = cld_sign_plot_height_pool,
    aes(x = Treatment,
        y = Inf,
        label = .group), cjust = 1,
    size = 4
  ) +
  theme_classic() +
  scale_fill_manual(
    values = c(
      "12SP" = "darkolivegreen",
      "2SP"  = "darkseagreen2",
      "6SP"  = "darkseagreen",
      "M1"   = "firebrick",
      "M2"   = "coral"
    ),
    guide = "none"
  ) +
  labs(
    x = "Treatment",
    y = "Average Plot-level Height"
  )

print(avgheight_pool)

### 7️⃣ Save plot
ggsave("~/Desktop/avgheight_pool.jpeg",
       plot = avgheight_pool,
       width = 8,
       height = 5.5,
       dpi = 300)

ggsave("~/Desktop/avgheight_pool.svg",
       plot = avgheight_pool)

```


```{r Calculate RGR}
# Add the RGR for Height to TreeDataGrowth 
TreeDataGrowthHeight <- TreeDataGrowth %>%
  filter(Height_2023!=1e-6)%>%
  mutate(
    RGR_Height = (log(Height_2024) - log(Height_2023)) / 365,
  )

# Add the RGR for BA to TreeDataGrowthBA, but first remove all the rows where BA_2023 == 0
TreeDataGrowthBA <- TreeDataGrowth %>%
  filter(BA_2023!=1e-6 ) %>%  
  mutate(
    RGR_BA = (log(BA_2024) - log(BA_2023)) / 365
  )

#There are negative RGRs so filter them out
TreeDataGrowthHeight <- TreeDataGrowthHeight %>% 
  filter(RGR_Height > 0)
TreeDataGrowthBA <- TreeDataGrowthBA %>% 
  filter(RGR_BA > 0)
```

```{r Subset databases for species present in monocultures}
#make a table with the monoculture species, treatment and site
MonocultureSpecies <- TreeDataGrowth %>%
  filter(Treatment %in% c("M1")) %>%
  dplyr::select(Site, Treatment, Species) %>% 
  distinct()

TreeDataSubset <- TreeDataGrowth %>%
  semi_join(MonocultureSpecies, by = "Species")
```

```{r Summary statistics (mean)}
SubsetSummary <- TreeDataSubset %>%
  group_by(Site, Treatment, Species) %>%
  summarise(
    Mean_BA_3 = mean(BA_year_3, na.rm = TRUE),
    sd_BA_3 = sd(BA_year_3, na.rm = TRUE),
    Mean_Height_3 = mean(Height_year_3, na.rm = TRUE),
    sd_Height_3 = sd(Height_year_3, na.rm = TRUE),
    .groups = "drop"
  ) %>% 
  mutate(Treatment = factor(Treatment, levels = c("M1", "M2", "2SP", "6SP", "12SP"))
    ) #reorder dataset for nicer plotting
```

```{r Plot mean BA}
ggplot(SubsetSummary, aes(x = Treatment, y = Mean_BA_3, color = Species, group = Species)) +
  geom_point(size = 6, alpha = 0.6) +
  geom_line(size = 1, alpha = 0.75)+
  scale_color_brewer(palette = "Dark2")+
  facet_wrap(~Site) +
  theme_classic() +
  labs(
    title = "Mean basal area of monoculture species across treatments",
    x = "Treatment",
    y = "Mean Basal Area (cm2)"
  )

```

```{r Plot mean Height}
ggplot(SubsetSummary, aes(x = Treatment, y = Mean_Height_3, color = Species, group = Species)) +
  geom_point(size = 5, alpha = 0.6) +
  geom_line(size = 0.8, alpha = 0.75)+
  scale_color_brewer(palette = "Dark2")+
  facet_wrap(~Site) +
  theme_classic() +
  labs(
    title = "Mean height of monoculture species across treatments",
    x = "Treatment",
    y = "Mean Height (cm)"
  )

```

```{r Plot mean Height 2024}
ggplot(SubsetSummaryHeight, aes(x = Treatment, y = Mean_Height_2024, color = Species, group = Species)) +
  geom_point(size = 5, alpha = 0.6) +
  geom_line(size = 0.8, alpha = 0.75)+
  scale_color_brewer(palette = "Dark2")+
  facet_wrap(~Site) +
  theme_minimal() +
  labs(
    title = "Mean height (2024) of monoculture species across treatments",
    x = "Treatment",
    y = "Mean Height (cm)"
  )

```

```{r Plot mean RGR BA}
ggplot(SubsetSummaryBA, aes(x = Treatment, y = Mean_RGR_BA, color = Species, group = Species)) +
  geom_point(size = 6, alpha = 0.6) +
  geom_line(size = 1, alpha = 0.75)+
  scale_color_brewer(palette = "Dark2")+
  facet_wrap(~Site) +
  theme_minimal() +
  labs(
    title = "Mean RGR of monoculture species' basal area across treatments",
    x = "Treatment",
    y = "Mean RGR (Basal Area)"
  )

```

```{r Plot mean RGR Height}
ggplot(SubsetSummaryHeight, aes(x = Treatment, y = Mean_RGR_Height, color = Species, group = Species)) +
  geom_point(size = 5, alpha = 0.6) +
  geom_line(size = 0.8, alpha = 0.75)+
  scale_color_brewer(palette = "Dark2")+
  facet_wrap(~Site) +
  theme_minimal() +
  labs(
    title = "Mean RGR of monoculture species' height across treatments",
    x = "Treatment",
    y = "Mean RGR (Height)"
  )

```

```{r Statistical analysis (fit models)}
library(lme4)
lm_height2024 <- lm(Mean_Height_2024 ~ Treatment * Site + Species, data = SubsetSummary)
lm_ba2024 <- lm(Mean_BA_2024 ~ Treatment * Site + Species, data = SubsetSummary)
lm_height2023 <- lm(Mean_Height_2023 ~ Treatment * Site + Species, data = SubsetSummary)
lm_ba2023<- lm(Mean_BA_2023 ~ Treatment * Site + Species, data = SubsetSummary)
lm_RGR_ba<- lm(Mean_RGR_Height ~ Treatment * Site + Species, data = SubsetSummary)
lm_RGR_height<- lm(Mean_RGR_BA ~ Treatment * Site + Species, data = SubsetSummary)
```

```{r Plot also other species - BA}
# Identify species that are NOT in monoculture treatment (M1)
NonMonocultureSpecies <- TreeDataGrowth %>%
  filter(!Species %in% MonocultureSpecies$Species)

# Calculate the mean BA of all other species per Plot, Treatment and Site
OtherSpeciesSummary <- NonMonocultureSpecies %>%
  group_by(Site, Treatment, Plot_number, Species) %>%
  summarise(
    Mean_BA_3 = mean(BA_year_3, na.rm = TRUE),
    sd_BA_3 = sd(BA_year_3,na.rm = TRUE),
    Mean_Height_3 = mean(Height_year_3, na.rm = TRUE),
    sd_Height_3 = sd(Height_year_3, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(Species = "All Other Species") # Label them as a single category

#Calculate the treatment avg
OtherSpeciesSummaryavg <- OtherSpeciesSummary %>%
  group_by(Site, Treatment, Species) %>%
  summarise(
    Mean_BA_3 = mean(Mean_BA_3, na.rm = TRUE),
    sd_BA_3 = mean(sd_BA_3,na.rm = TRUE),
    Mean_Height_3 = mean(Mean_Height_3, na.rm = TRUE),
    sd_Height_3 = mean(sd_Height_3, na.rm = TRUE),
    .groups = "drop"
  ) 

# Ensure Treatment levels are correctly ordered
OtherSpeciesSummaryavg <- OtherSpeciesSummaryavg %>%
  mutate(Treatment = factor(Treatment, levels = c("M1", "M2", "2SP", "6SP", "12SP")))

# Combine Monoculture species summary with the Other Species summary
CombinedSummary <- bind_rows(SubsetSummary, OtherSpeciesSummaryavg)

#plot BA 
monocultureBA3<-ggplot(CombinedSummary, aes(x = Treatment, y = Mean_BA_3, color = Species, group = Species)) +
  geom_point(size = 10, alpha = 0.6) +
  geom_errorbar(aes(ymin = Mean_BA_3 - sd_BA_3, ymax = Mean_BA_3 +sd_BA_3), width = 0.15,    # Width of horizontal caps
               #linetype = "dashed", # Dashed whisker lines
               size = 0.4) +
  geom_line(size = 2, alpha = 0.8, type ="dashed") +
  scale_color_manual(values = c(brewer.pal(n = 8, name = "Dark2"), "black")) + # Custom colors, "black" for other species
  theme_classic() +
  facet_wrap(~Site)+
  theme(legend.position = "none")+
  labs(
    x = "Treatment",
    y = expression(" Mean Individual BA (" * cm^2 * ")")
  )+
  theme(
    axis.title = element_text(size = 16),  # Increase axis title size
  )

print(monocultureBA3)
#save plot
ggsave("~/Desktop/monocultureBA3.jpeg", plot=monocultureBA3, width = 5, height = 5, dpi = 300)
ggsave("~/Desktop/monocultureBA3.svg", plot=monocultureBA3)
```
