---
title: "Canopy cover 2025"
author: "Rachele Quaglino"
date: "8/17/2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Load Packages, echo=FALSE}
library(dplyr)
library(ggplot2)
library(lme4)
library(lmerTest)
library(ineq)
library(performance)
library(emmeans)
library(tidyr)
library(readxl)
library(glmmTMB)   # For beta regression with mixed effects
library(car)       # For Type III ANOVA
library(DHARMa)
```

```{r get data}
CanopyCover <- read_excel("~/Desktop/Master/3. master thesis/Data/2026/FDiv_PlantedTreeData_final_excel.xlsx", sheet = "CanopyCover")

View(CanopyCover)     

#Rename treatments
CanopyCover <- CanopyCover %>%
  mutate(Treatment = toupper(Treatment))

#Reorder treatments
CanopyCover$Treatment <- factor(CanopyCover$Treatment, levels = c("C", "M1", "M2", "2SP", "6SP", "12SP"))
```


```{r Summary year 3, echo = FALSE}
CanopyCover3 <- CanopyCover %>% 
  filter(Year == "3")

CanopyCover_summary<-CanopyCover3 %>%
  group_by(Site, Treatment, `Plot identification`) %>%
  summarise(
    Plot_Canopy_Cover = mean(Percent_canopy_cover, na.rm = TRUE),
    SD_Canopy_Cover = sd(Percent_canopy_cover, na.rm = TRUE),
    n = n()
  )


CanopyCover_summary_avg<- CanopyCover_summary %>% 
  group_by(Site, Treatment)%>%
  summarise(
   mean_canopy = mean(Plot_Canopy_Cover, na.rm = TRUE),
   sd_canopy = sd(Plot_Canopy_Cover, na.rm = TRUE),
  )

```

```{r Model canopy cover year 3}
# Fit the linear mixed-effects model
canopy_model <- lmer(Plot_Canopy_Cover ~ Treatment * Site + (1 | Site/`Plot identification`), data =CanopyCover_summary)

summary(canopy_model)

Anova(canopy_model, type=3)
# Check model fit by plotting residuals
simulationOutput <- simulateResiduals(fittedModel = canopy_model, plot = TRUE)
plot(simulationOutput)
# Extra diagnostic tests
testDispersion(simulationOutput)     # Over dispersion check
testZeroInflation(simulationOutput)  # Zero-inflation check


#calculate significant differences
anova(canopy_model, type = "III")
#extract model means
means_canopy <- emmeans (canopy_model, pairwise ~ Treatment | Site , type = "response", data = CanopyCover_summary)

cld_sign_canopy <- as.data.frame(cld(means_canopy, Letters = letters, adjust = "Tukey", alpha = 0.05, decreasing = TRUE))
```


```{r Plot canopy cover year 3}
canopybar<-ggplot(CanopyCover_summary_avg, aes(x = Treatment, y = mean_canopy , fill=Treatment)) +
  geom_bar(stat = "identity", color = "black") +
  geom_jitter(data = CanopyCover_summary, 
              aes(x = Treatment, y = Plot_Canopy_Cover), 
              width = 0.2,  # Horizontal scatter
              size = 1.5,  # Point size
              alpha = 0.5, # Transparency
              color = "black") + # Point color
   geom_errorbar(aes(ymin = pmax(mean_canopy - sd_canopy, 0), ymax = mean_canopy +                sd_canopy), width = 0.2,    # Width of horizontal caps
               size = 0.5) +
  geom_text(data = cld_sign_canopy, family= "sans", show.legend = FALSE,
            check_overlap = FALSE, size = 3, vjust = 1,
            aes(x=Treatment,y=Inf,label=.group ))+
  scale_fill_manual(values = c( "12SP" = "darkolivegreen",
                               "2SP" = "darkseagreen2", 
                               "6SP" = "darkseagreen", 
                               "M1" = "firebrick", 
                               "M2"= "coral"), guide = "none") +
  facet_wrap(~ Site) +  # Creates a separate panel for each site
  labs(
       x = "Treatment",
       y = "Mean Canopy Cover (%)") +
  theme(legend.position = "none")+
  theme_classic()
print(canopybar)
#save plot
ggsave("~/Desktop/canopy_barplot_year_3.jpeg", plot=canopybar, width = 8, height = 5, dpi = 300)
ggsave("~/Desktop/canopy_barplot_year_3.svg", plot=canopybar)
```

```{r Plot canopy cover year 3 - pooled}
CanopyCover_avg_pooled<-CanopyCover3 %>%
  group_by(Treatment) %>%
  summarise(
    mean_canopy = mean(Percent_canopy_cover, na.rm = TRUE),
    sd_canopy = sd(Percent_canopy_cover, na.rm = TRUE),
    n = n()
  )

CanopyCover_summary_pooled<-CanopyCover3 %>%
  group_by(Treatment, `Plot identification`) %>%
  summarise(
    Plot_Canopy_Cover = mean(Percent_canopy_cover, na.rm = TRUE),
    SD_Canopy_Cover = sd(Percent_canopy_cover, na.rm = TRUE),
    n = n()
  )

canopy_model_pooled <- lmer(Plot_Canopy_Cover ~ Treatment + (1 | Site), data =CanopyCover_summary)

means_canopy_pooled <- emmeans (canopy_model_pooled, pairwise ~ Treatment, type = "response", data = CanopyCover_summary)

cld_sign_canopy_pooled <- as.data.frame(cld(means_canopy_pooled, Letters = letters, adjust = "Tukey", alpha = 0.05, decreasing = TRUE))

# If you want a data frame:
cld_sign_canopy_pooled <- as.data.frame(cld_sign_canopy_pooled)

canopybar_pooled<-ggplot(CanopyCover_avg_pooled, aes(x = Treatment, y = mean_canopy , fill=Treatment)) +
  geom_bar(stat = "identity", color="black") +
  geom_jitter(data = CanopyCover_summary_pooled, 
              aes(x = Treatment, y = Plot_Canopy_Cover), 
              width = 0.2,  # Horizontal scatter
              size = 1.5,  # Point size
              alpha = 0.5, # Transparency
              color = "black") + # Point color
   geom_errorbar(aes(ymin = pmax(mean_canopy - sd_canopy, 0), ymax = mean_canopy +                sd_canopy), width = 0.2,    # Width of horizontal caps
               size = 0.5) +
  geom_text(data = cld_sign_canopy_pooled, family= "sans", show.legend = FALSE,
            check_overlap = FALSE, size = 3, vjust = 1,
            aes(x=Treatment,y=Inf,label=.group ))+
  scale_fill_manual(values = c( "12SP" = "darkolivegreen",
                               "2SP" = "darkseagreen2", 
                               "6SP" = "darkseagreen", 
                               "M1" = "firebrick", 
                               "M2"= "coral"), guide = "none") +
  labs(
       x = "Treatment",
       y = "Mean Canopy Cover (%)") +
  theme(legend.position = "none")+
  theme_classic()

#save plot
ggsave("~/Desktop/canopyyear3_pooled.jpeg", plot=canopybar_pooled, width = 8, height = 5, dpi = 300)
ggsave("~/Desktop/canopyyear3_pooled.svg", plot=canopybar_pooled)
```

```{r Gini canopy cover and model}
gini_canopy_cover <- CanopyCover %>%  
  filter(Year == "3") %>% 
  group_by(Site, Treatment, `Plot identification`) %>%
  summarize(
    Gini_Canopy = ineq(Percent_canopy_cover, type = "Gini")) 
 
gini_canopy_summary <- gini_canopy_cover %>%
  group_by(Site, Treatment) %>%
  summarize(mean_gini = mean(Gini_Canopy, na.rm = TRUE),
            sd_gini = sd(Gini_Canopy, na.rm = TRUE),
  )  

# Fit the linear mixed-effects model
gini_model_canopy <- lmer(Gini_Canopy ~ Treatment * Site + (1 |`Plot identification`), data = gini_canopy_cover)

summary(canopy_model)

# Check model fit by plotting residuals
simulationOutput <- simulateResiduals(fittedModel = canopy_model, plot = TRUE)
plot(simulationOutput)
# Extra diagnostic tests
testDispersion(simulationOutput)     # Over dispersion check
testZeroInflation(simulationOutput)  # Zero-inflation check

#calculate significant differences
anova(gini_model_canopy, type = "III")
#extract model means
means_gini <- emmeans (gini_model_canopy, pairwise ~ Treatment | Site , type = "response", data = gini_canopy_cover)

cld_sign_gini <- as.data.frame(cld(means_gini, Letters = letters, adjust = "Tukey", alpha = 0.05, decreasing = TRUE))


ginicanopybar <- ggplot(gini_canopy_summary, aes(x = Treatment, y = mean_gini , fill=Treatment)) +
  geom_bar(stat = "identity", color = "black") +
  geom_jitter(data = gini_canopy_cover, 
              aes(x = Treatment, y = Gini_Canopy), 
              width = 0.2,  # Horizontal scatter
              size = 1.5,  # Point size
              alpha = 0.5, # Transparency
              color = "black") + # Point color
   geom_errorbar(aes(ymin = pmax(mean_gini - sd_gini, 0), ymax = mean_gini +                sd_gini), width = 0.2,    # Width of horizontal caps
               size = 0.5) +
  geom_text(data = cld_sign_gini, family= "sans", show.legend = FALSE,
            check_overlap = FALSE, size = 3, vjust = 1,
            aes(x=Treatment,y=Inf,label=.group ))+
  scale_fill_manual(values = c( "12SP" = "darkolivegreen",
                               "2SP" = "darkseagreen2", 
                               "6SP" = "darkseagreen",
                               "M1" = "firebrick", 
                               "M2"= "coral"), guide = "none") +
  facet_wrap(~ Site) +  # Creates a separate panel for each site
  labs(
       x = "Treatment",
       y = "Gini coefficient of canopy cover") +
  theme(legend.position = "none")+
  theme_classic()

#save plot
ggsave("~/Desktop/ginicanopyyear3.jpeg", plot=ginicanopybar, width = 8, height = 5, dpi = 800)
ggsave("~/Desktop/ginicanopyyear3.svg", plot=ginicanopybar)
```  
```{r Gini canopy cover - pooled}
gini_summary_3_pooled <- gini_canopy_cover %>%
  group_by(Treatment) %>%
  summarize(
    mean_gini = mean(Gini_Canopy, na.rm = TRUE),
    sd_gini   = sd(Gini_Canopy, na.rm = TRUE),
    n         = sum(!is.na(Gini_Canopy)),
    se_gini   = sd_gini / sqrt(n),
    ci_gini   = qt(0.975, df = n - 1) * se_gini
  )

gini_canopy_model_pooled <- lmer(Gini_Canopy ~ Treatment + (1 | Site), data =gini_canopy_cover)

gini_means_canopy_pooled <- emmeans (gini_canopy_model_pooled, pairwise ~ Treatment, type = "response", data = gini_canopy_cover)

cld_sign_gini_canopy_pooled <- as.data.frame(cld(gini_means_canopy_pooled, Letters = letters, adjust = "Tukey", alpha = 0.05, decreasing = TRUE))

# If you want a data frame:
cld_sign_gini_canopy_pooled <- as.data.frame(cld_sign_gini_canopy_pooled)

ginicanopy_pooled<-ggplot(gini_summary_3_pooled, aes(x = Treatment, y = mean_gini , fill=Treatment)) +
  geom_bar(stat = "identity", color="black") +
  geom_jitter(data = gini_canopy_cover, 
              aes(x = Treatment, y = Gini_Canopy), 
              width = 0.2,  # Horizontal scatter
              size = 1.5,  # Point size
              alpha = 0.5, # Transparency
              color = "black") + # Point color
  geom_errorbar(aes(ymin = pmax(mean_gini - ci_gini, 0),
                  ymax = mean_gini + ci_gini),
              width = 0.2,
              size = 0.5)+
  geom_text(data = cld_sign_gini_canopy_pooled, family= "sans", show.legend = FALSE,
            check_overlap = FALSE, size = 3, vjust = 1,
            aes(x=Treatment,y=Inf,label=.group ))+
  scale_fill_manual(values = c( "12SP" = "darkolivegreen",
                               "2SP" = "darkseagreen2", 
                               "6SP" = "darkseagreen", 
                               "M1" = "firebrick", 
                               "M2"= "coral"), guide = "none") +
  labs(
       x = "Treatment",
       y = "Gini coefficient of canopy cover") +
  theme(legend.position = "none")+
  theme_classic()
print(ginicanopy_pooled)
#save plot
ggsave("~/Desktop/ginicanopy_pooled.jpeg", plot=ginicanopy_pooled, width = 8, height = 5, dpi = 300)
ggsave("~/Desktop/ginicanopy_pooled.svg", plot=ginicanopy_pooled)
```
